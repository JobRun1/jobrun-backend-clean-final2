# Phase 4 Inbound SMS AI Pipeline - Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CUSTOMER                                 â”‚
â”‚                     (Sends SMS via Phone)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TWILIO CLOUD                               â”‚
â”‚                  (Receives & Routes SMS)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP POST /twilio/sms
                         â”‚ Body: { From, Body, MessageSid }
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   JOBRUN BACKEND SERVER                          â”‚
â”‚                   (Express + TypeScript)                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  routes/twilio.ts - Webhook Handler                        â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  1. Resolve Client (DEFAULT_CLIENT_ID)                     â”‚ â”‚
â”‚  â”‚  2. Resolve/Create Lead (phone number)                     â”‚ â”‚
â”‚  â”‚  3. Store Inbound Message (Prisma â†’ PostgreSQL)            â”‚ â”‚
â”‚  â”‚  4. Load Client Settings                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                        â”‚
â”‚                         â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ai/pipelines/inboundSmsPipeline.ts                        â”‚ â”‚
â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 1ï¸âƒ£ SENTINEL (Safety Guard)                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Block unsafe content                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Validate message length                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Profanity & spam detection                     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ âœ… Allowed                         â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 2ï¸âƒ£ VAULT (Context Loader)                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Load lead record                               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Fetch last 20 messages                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Build conversation history                     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ context: { lead, messages[] }      â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 3ï¸âƒ£ DIAL (Intent Classifier)                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - OpenAI GPT-4o-mini                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Classify: GREETING, QUESTION, BOOKING, etc.    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Return confidence score                        â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ intent, confidence                 â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 4ï¸âƒ£ FLOW (Entity Extractor)                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - OpenAI GPT-4o-mini                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Extract: jobType, location, urgency            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Structured JSON output                         â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ entities: { jobType?, ... }        â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 5ï¸âƒ£ RUNE (Decision Engine)                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Business logic rules                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Decide: ASK_QUESTION, SEND_BOOKING_LINK, etc.  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Determine state transition event               â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ action, stateEvent                 â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 6ï¸âƒ£ STATE MACHINE                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Update lead status                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - NEW â†’ CONTACTED â†’ QUALIFIED â†’ CONVERTED        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Prisma update                                  â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ updatedLead                        â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 7ï¸âƒ£ LYRA (Reply Generator)                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - OpenAI GPT-4o                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Use configured AI tone                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Generate SMS-optimized reply                   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Inject booking URL if needed                   â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ replyMessage                       â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 8ï¸âƒ£ SENTINEL (Outbound Safety Check)                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Validate outbound message                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Final safety pass                              â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚ âœ… Safe to send                    â”‚ â”‚
â”‚  â”‚                        â–¼                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ 9ï¸âƒ£ LOGGER (Event Logging)                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Store outbound message                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Save metadata (intent, action, entities)       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    - Database persistence                           â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                        â”‚                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Return TwiML Response                                     â”‚ â”‚
â”‚  â”‚  <Response><Message>AI reply here</Message></Response>     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TWILIO CLOUD                               â”‚
â”‚                    (Sends SMS to Customer)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CUSTOMER                                 â”‚
â”‚                   (Receives AI Reply)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### Inbound Message Flow
```
Phone Number â†’ Twilio â†’ Webhook â†’ resolveLead() â†’ Database (messages)
                                      â†“
                                 handleInboundSms()
                                      â†“
                              AI Pipeline (9 steps)
                                      â†“
                              replyMessage + updatedLead
                                      â†“
                              TwiML Response â†’ Twilio â†’ Customer
```

### Agent Communication
```
SENTINEL â†’ VAULT â†’ DIAL â†’ FLOW â†’ RUNE â†’ STATE â†’ LYRA â†’ SENTINEL â†’ LOGGER
   â†“         â†“       â†“      â†“       â†“       â†“      â†“        â†“        â†“
  bool    context  intent entities action  lead  reply    bool   message
```

## Database Schema (Relevant Tables)

```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    clients      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚ â†â”€â”€â”€â”€â”€â”
â”‚ businessName    â”‚       â”‚
â”‚ phoneNumber     â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚client_settings  â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚ id              â”‚       â”‚
â”‚ clientId        â”‚ â”€â”€â”€â”€â”€â”€â”˜
â”‚ metadata (JSON) â”‚
â”‚  - aiTone       â”‚
â”‚  - bookingUrl   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     leads       â”‚       â”‚    messages     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚ â†â”€â”€â”€â” â”‚ id              â”‚
â”‚ clientId        â”‚     â””â”€â”‚ customerId      â”‚
â”‚ phone           â”‚       â”‚ clientId        â”‚
â”‚ status          â”‚       â”‚ direction       â”‚
â”‚ name            â”‚       â”‚ type            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ body            â”‚
                          â”‚ metadata (JSON) â”‚
                          â”‚  - intent       â”‚
                          â”‚  - action       â”‚
                          â”‚  - entities     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Agent Implementations

### File Structure
```
apps/backend/src/ai/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ sentinel.ts     (Safety screening)
â”‚   â”œâ”€â”€ vault.ts        (Context loading)
â”‚   â”œâ”€â”€ dial.ts         (Intent classification)
â”‚   â”œâ”€â”€ flow.ts         (Entity extraction)
â”‚   â”œâ”€â”€ rune.ts         (Decision engine)
â”‚   â”œâ”€â”€ lyra.ts         (Reply generation)
â”‚   â””â”€â”€ aiLogger.ts     (Event logging)
â””â”€â”€ pipelines/
    â””â”€â”€ inboundSmsPipeline.ts (Orchestrator)
```

### Agent Inputs/Outputs

```typescript
// SENTINEL
Input:  { clientId, lead, messageText }
Output: { allowed: boolean, reason?: string }

// VAULT
Input:  { clientId, leadId }
Output: { lead: Lead, messages: Message[] }

// DIAL
Input:  { text, context: Message[] }
Output: { intent: IntentType, confidence: number }

// FLOW
Input:  { text, context: Message[], intent: IntentType }
Output: { jobType?, location?, urgency?, extraDetails? }

// RUNE
Input:  { lead, intent, entities, clientSettings, messageCount }
Output: { action: NextAction, stateEvent?, explanation? }

// LYRA
Input:  { clientSettings, action, intent, entities, recentMessages, businessName }
Output: string (SMS reply text)
```

## External Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenAI API    â”‚ â† GPT-4o, GPT-4o-mini
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â†’ DIAL (Intent Classification)
         â”œâ”€â†’ FLOW (Entity Extraction)
         â””â”€â†’ LYRA (Reply Generation)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL DB  â”‚ â† Prisma ORM
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â†’ VAULT (Load context)
         â”œâ”€â†’ STATE MACHINE (Update lead)
         â””â”€â†’ LOGGER (Store messages)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Twilio API     â”‚ â† SMS Gateway
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â†’ Inbound: Webhook â†’ Backend
         â””â”€â†’ Outbound: TwiML â†’ Customer
```

## State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”  GREETING/QUESTION      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NEW  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ CONTACTED â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ BOOKING_REQUEST
                                         â”‚ + Clear Job Info
                                         â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ QUALIFIED â”‚
                                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ (Manual/Future)
                                         â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ CONVERTED â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Any state can â†’ LOST (manual escalation)
```

## Configuration Flow

```
ClientSettings (metadata)
         â”‚
         â”œâ”€â†’ aiTone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ LYRA (Reply style)
         â”œâ”€â†’ bookingUrl â”€â”€â”€â”€â”€â”€â”€â”€â†’ RUNE (Decision logic)
         â”‚                   â””â”€â”€â†’ LYRA (URL injection)
         â””â”€â†’ businessName â”€â”€â”€â”€â”€â”€â†’ LYRA (Personalization)
```

## Error Handling

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Pipeline Error â”€â”€â”€â†’ â”‚ Catch & Log      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Fallback Message â”‚
                    â”‚ "Sorry, having   â”‚
                    â”‚  trouble..."     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                       Send to Customer
```

## Performance Characteristics

| Step     | Typical Latency | API Calls |
|----------|-----------------|-----------|
| SENTINEL | < 10ms          | 0         |
| VAULT    | < 50ms          | 0 (DB)    |
| DIAL     | 500-1500ms      | 1 (OpenAI)|
| FLOW     | 500-1500ms      | 1 (OpenAI)|
| RUNE     | < 10ms          | 0         |
| STATE    | < 50ms          | 0 (DB)    |
| LYRA     | 1000-2500ms     | 1 (OpenAI)|
| LOGGER   | < 50ms          | 0 (DB)    |

**Total Pipeline**: 2-5 seconds (acceptable for SMS)

## Security Layers

```
1. SENTINEL (Inbound)  â”€â†’ Block unsafe content
2. Input Validation    â”€â†’ Sanitize SQL, XSS
3. Multi-tenant Auth   â”€â†’ clientId isolation
4. API Key Protection  â”€â†’ Environment variables
5. SENTINEL (Outbound) â”€â†’ Validate AI output
6. Database ACL        â”€â†’ Row-level security
```

## Monitoring Points

```
ğŸ“Š Metrics to Track:
â”œâ”€ Pipeline execution time (target: < 5s)
â”œâ”€ OpenAI API usage (tokens, cost)
â”œâ”€ Intent classification accuracy
â”œâ”€ Lead conversion rate (NEW â†’ QUALIFIED)
â”œâ”€ SENTINEL block rate (safety)
â”œâ”€ Error rate (pipeline failures)
â””â”€ Message volume (per client)
```

## Scalability Considerations

```
Current:  Single client (DEFAULT_CLIENT_ID)
Future:   Multi-tenant routing
          â”œâ”€ Phone number â†’ Client mapping
          â”œâ”€ Per-client settings
          â””â”€ Isolated conversation contexts

Horizontal Scaling:
â”œâ”€ Stateless pipeline (scales via load balancer)
â”œâ”€ Database connection pooling (Prisma)
â””â”€ OpenAI API rate limits (tier-based)
```

---

**This architecture implements the 24-agent JobRun OS with 7 specialized agents working in concert to provide intelligent, automated customer conversations via SMS.**
