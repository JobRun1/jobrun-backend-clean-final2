// =====================================
// JobRun Phase 2 — Communication Engine
// Multi-tenant + Communication + Booking
// =====================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// CLIENT — A business using JobRun
// ================================
model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessName String
  region       String
  phoneNumber  String? // Twilio number for this client

  // Business hours (JSON format)
  businessHours Json? // {"start": "09:00", "end": "17:00", "days": [1,2,3,4,5]}
  timezone      String @default("America/New_York")

  // Demo mode control
  demoToolsVisible Boolean @default(true)

  // Relations
  users         User[]
  customers     Customer[]
  conversations Conversation[]
  messages      Message[]
  bookings      Booking[]

  @@map("clients")
}

// ================================
// USER — Auth and access
// ================================
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email    String   @unique
  password String // Hashed password
  role     UserRole

  // Multi-tenant relation
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("users")
}

// ================================
// CUSTOMER — A customer/lead
// ================================
model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  phone String // Customer's phone number
  name  String? // Customer name (collected later)
  email String? // Customer email (optional)

  // Relations
  messages      Message[]
  conversations Conversation[]
  bookings      Booking[]

  @@unique([clientId, phone], name: "clientId_phone")
  @@index([clientId])
  @@index([phone])
  @@map("customers")
}

// ================================
// CONVERSATION — Thread of messages
// ================================
model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Relations
  messages Message[]

  @@index([clientId])
  @@index([customerId])
  @@map("conversations")
}

// ================================
// MESSAGE — Individual message
// ================================
model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  direction MessageDirection
  type      MessageType
  body      String           @db.Text

  // Twilio metadata
  twilioSid String? @unique

  // System metadata
  metadata Json?

  @@index([clientId])
  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// ================================
// BOOKING — Calendar appointment
// ================================
model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  start  DateTime
  end    DateTime
  status BookingStatus @default(NEW)

  customerName  String?
  customerPhone String?
  customerEmail String?

  notes String? @db.Text
  color String? @db.VarChar

  // Recurrence support
  recurrenceRuleId String?         @db.VarChar
  recurrenceRule   RecurrenceRule? @relation(fields: [recurrenceRuleId], references: [id])
  isAllDay         Boolean         @default(false)

  // External calendar sync (for future Google sync)
  externalSyncId   String? @db.VarChar
  externalCalendar String? @db.VarChar

  @@index([clientId, start])
  @@index([clientId, status])
  @@index([customerId])
  @@index([recurrenceRuleId])
  @@index([isAllDay])
  @@map("bookings")
}

// ================================
// RECURRENCE RULE — Booking recurrence patterns
// ================================
model RecurrenceRule {
  id          String              @id @default(cuid())
  clientId    String
  frequency   RecurrenceFrequency
  interval    Int                 @default(1)
  byWeekday   String? // Comma-separated weekdays
  byMonthday  String? // For monthly rules
  endDate     DateTime?
  occurrences Int?
  bookings    Booking[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("recurrence_rules")
}

// ================================
// WEEKLY AVAILABILITY — Recurring weekly availability slots
// ================================
model WeeklyAvailability {
  id        String @id @default(cuid())
  clientId  String
  weekday   Int // 0=Sun, 6=Sat
  startTime String // "09:00"
  endTime   String // "17:00"

  @@map("weekly_availability")
}

// ================================
// BLOCKED TIME — Manual blocked time periods
// ================================
model BlockedTime {
  id       String   @id @default(cuid())
  clientId String
  date     DateTime
  start    String? // null means all-day
  end      String?
  reason   String?

  @@map("blocked_times")
}

// ================================
// AGENT LOG — Phase 3 Agent System
// ================================
model AgentLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  agentName String

  clientId String

  customerId String?

  conversationId String?

  trigger String // AgentTriggerType as string

  input  Json // AgentContext input
  output Json? // AgentOutput or null if failed
  error  String? @db.Text

  executionTimeMs Int

  @@index([clientId])
  @@index([agentName])
  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("agent_logs")
}

// ================================
// CLIENT SETTINGS — Phase 3 Business Settings
// ================================
model ClientSettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String @unique

  // Business Information
  businessName String?
  services     String? @db.Text // Comma-separated or JSON
  availability String? @db.Text // Business hours description
  pricing      String? @db.Text // Pricing information

  // Contact
  phoneNumber String?
  email       String?
  website     String?

  // Service Area
  serviceArea String? @db.Text

  // Theme Configuration
  theme Json? // Stores ThemeConfig object: { name, id, colors, glow }

  // Agent Settings
  agentSettings Json? // Stores agent enable/disable states

  // Additional settings as JSON
  metadata Json?

  @@map("client_settings")
}

// ================================
// LEAD — Phase 3 Lead Management
// ================================
model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId String

  phone String
  name  String?
  email String?

  source LeadSource @default(INBOUND)
  status LeadStatus @default(NEW)

  notes String? @db.Text

  // Qualification data
  qualificationData Json?

  @@unique([clientId, phone], name: "clientId_phone")
  @@index([clientId])
  @@index([phone])
  @@index([status])
  @@map("leads")
}

// ================================
// HANDOVER STATE — Phase 11A Human Handover
// ================================
model HandoverState {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String @unique
  clientId       String

  active       Boolean
  reason       String?    @db.Text
  urgencyScore Int        @default(5)
  triggers     Json? // Array of trigger strings

  lastNotificationAt DateTime?

  @@index([clientId])
  @@index([active])
  @@index([urgencyScore])
  @@map("handover_states")
}

// ================================
// ENUMS
// ================================

enum UserRole {
  ADMIN
  CLIENT
}

enum MessageDirection {
  INBOUND
  OUTBOUND
  SYSTEM
}

enum MessageType {
  SMS
  CALL
  NOTE
  EVENT
}

enum BookingStatus {
  NEW
  CONFIRMED
  CANCELLED
  MISSED
  RESCHEDULED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum LeadSource {
  INBOUND
  OUTBOUND
  REFERRAL
  WEBSITE
  OTHER
  FAKE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}
