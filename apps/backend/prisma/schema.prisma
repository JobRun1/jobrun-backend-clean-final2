generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ──────────────────────────────────────────────
// CLIENT
// ──────────────────────────────────────────────
model Client {
  id               String         @id @default(cuid())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  businessName     String
  region           String
  phoneNumber      String?
  twilioNumber     String?
  businessHours    Json?
  timezone         String         @default("America/New_York")
  demoToolsVisible Boolean        @default(true)
  demoClient       Boolean        @default(false)

  bookings         Booking[]
  conversations    Conversation[]
  customers        Customer[]
  messages         Message[]
  users            User[]
  leads            Lead[]
  onboardingState  OnboardingState?
  billing          ClientBilling?
  controls         ClientControls?

  @@map("clients")
}

//
// ──────────────────────────────────────────────
// USER
// ──────────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email     String   @unique
  password  String
  role      UserRole

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("users")
}

//
// ──────────────────────────────────────────────
// CUSTOMER
// ──────────────────────────────────────────────
// REQUIRED FOR ADMIN DASHBOARD
//
model Customer {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  clientId      String
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)

  phone         String
  name          String?
  email         String?

  // NEW FIELD REQUIRED BY DASHBOARD
  state         CustomerState  @default(NEW)

  bookings         Booking[]
  conversations    Conversation[]
  messages         Message[]
  leads            Lead[]

  @@unique([clientId, phone], name: "clientId_phone")
  @@index([clientId])
  @@index([phone])
  @@index([state])
  @@map("customers")
}

//
// ──────────────────────────────────────────────
// CONVERSATION
// ──────────────────────────────────────────────
model Conversation {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  clientId   String
  customerId String?

  client     Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  messages   Message[]

  @@index([clientId])
  @@index([customerId])
  @@map("conversations")
}

//
// ──────────────────────────────────────────────
// MESSAGE
// ──────────────────────────────────────────────
model Message {
  id             String           @id @default(cuid())
  createdAt      DateTime         @default(now())

  clientId       String
  customerId     String?
  conversationId String?

  direction      MessageDirection
  type           MessageType
  body           String

  twilioSid      String?          @unique
  metadata       Json?

  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer       Customer?        @relation(fields: [customerId], references: [id])
  conversation   Conversation?    @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

//
// ──────────────────────────────────────────────
// BOOKING
// ──────────────────────────────────────────────
model Booking {
  id               String          @id @default(cuid())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  clientId         String
  customerId       String?

  start            DateTime
  end              DateTime
  status           BookingStatus   @default(NEW)

  customerName     String?
  customerPhone    String?
  customerEmail    String?
  notes            String?

  color            String?         @db.VarChar
  recurrenceRuleId String?         @db.VarChar
  isAllDay         Boolean         @default(false)
  externalSyncId   String?         @db.VarChar
  externalCalendar String?         @db.VarChar

  client           Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer         Customer?       @relation(fields: [customerId], references: [id])
  recurrenceRule   RecurrenceRule? @relation(fields: [recurrenceRuleId], references: [id])

  @@index([clientId, start])
  @@index([clientId, status])
  @@index([customerId])
  @@index([recurrenceRuleId])
  @@index([isAllDay])
  @@map("bookings")
}

//
// ──────────────────────────────────────────────
// RECURRENCE RULE
// ──────────────────────────────────────────────
model RecurrenceRule {
  id          String              @id @default(cuid())
  clientId    String

  frequency   RecurrenceFrequency
  interval    Int                 @default(1)

  byWeekday   String?
  byMonthday  String?
  endDate     DateTime?
  occurrences Int?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  bookings    Booking[]

  @@map("recurrence_rules")
}

//
// ──────────────────────────────────────────────
// WEEKLY AVAILABILITY
// ──────────────────────────────────────────────
model WeeklyAvailability {
  id        String @id @default(cuid())
  clientId  String
  weekday   Int
  startTime String
  endTime   String

  @@map("weekly_availability")
}

//
// ──────────────────────────────────────────────
// BLOCKED TIME
// ──────────────────────────────────────────────
model BlockedTime {
  id       String   @id @default(cuid())
  clientId String
  date     DateTime
  start    String?
  end      String?
  reason   String?

  @@map("blocked_times")
}

//
// ──────────────────────────────────────────────
// AGENT LOG
// ──────────────────────────────────────────────
model AgentLog {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())

  agentName       String
  clientId        String
  customerId      String?
  conversationId  String?

  trigger         String
  input           Json
  output          Json?
  error           String?
  executionTimeMs Int

  @@index([clientId])
  @@index([agentName])
  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("agent_logs")
}

//
// ──────────────────────────────────────────────
// CLIENT SETTINGS
// ──────────────────────────────────────────────
model ClientSettings {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clientId      String   @unique

  businessName  String?
  services      String?
  availability  String?
  pricing       String?
  phoneNumber   String?
  email         String?
  website       String?
  serviceArea   String?
  theme                 Json?
  agentSettings         Json?
  metadata              Json?
  notificationsPaused   Boolean  @default(false)

  @@map("client_settings")
}

//
// ──────────────────────────────────────────────
// LEAD (VAULT V1)
// ──────────────────────────────────────────────
model Lead {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientId      String
  customerId    String

  state         LeadState @default(NEW)
  jobType       String    @default("")
  urgency       String    @default("")
  location      String    @default("")
  requestedTime String    @default("")
  notes         String    @default("")

  sentBooking   Boolean   @default(false)
  askedClarify  Boolean   @default(false)
  escalated     Boolean   @default(false)

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([clientId, customerId], name: "clientId_customerId")
  @@index([clientId])
  @@index([customerId])
  @@index([state])
  @@map("leads")
}

//
// ──────────────────────────────────────────────
// IMPERSONATION LOG
// ──────────────────────────────────────────────
model ImpersonationLog {
  id        String   @id @default(cuid())
  adminId   String
  clientId  String
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([adminId])
  @@index([clientId])
  @@index([createdAt])
  @@map("impersonation_logs")
}

//
// ──────────────────────────────────────────────
// HANDOVER STATE
// ──────────────────────────────────────────────
model HandoverState {
  id                 String    @id @default(cuid())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  conversationId     String    @unique
  clientId           String

  active             Boolean
  reason             String?
  urgencyScore       Int       @default(5)
  triggers           Json?
  lastNotificationAt DateTime?

  @@index([clientId])
  @@index([active])
  @@index([urgencyScore])
  @@map("handover_states")
}

//
// ──────────────────────────────────────────────
// ONBOARDING STATE (CLIENT ONBOARDING)
// ──────────────────────────────────────────────
model OnboardingState {
  id                 String               @id @default(cuid())
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")

  clientId           String               @unique @map("client_id")
  client             Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)

  currentState       OnboardingStateEnum  @default(S1_BUSINESS_TYPE_LOCATION) @map("current_state")
  collectedFields    Json                 @default("{}") @map("collected_fields")

  lastMessageSid     String?              @map("last_message_sid")
  completedAt        DateTime?            @map("completed_at")

  phoneType          String?              @map("phone_type")
  forwardingEnabled  Boolean              @default(false) @map("forwarding_enabled")
  testCallDetected   Boolean              @default(false) @map("test_call_detected")
  stuckDetectedAt    DateTime?            @map("stuck_detected_at")

  @@index([currentState])
  @@index([lastMessageSid])
  @@map("onboarding_states")
}

//
// ──────────────────────────────────────────────
// ENUMS
// ──────────────────────────────────────────────
enum UserRole {
  ADMIN
  CLIENT
}

enum MessageDirection {
  INBOUND
  OUTBOUND
  SYSTEM
}

enum MessageType {
  SMS
  CALL
  NOTE
  EVENT
}

enum BookingStatus {
  NEW
  CONFIRMED
  CANCELLED
  MISSED
  RESCHEDULED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum LeadSource {
  INBOUND
  OUTBOUND
  REFERRAL
  WEBSITE
  OTHER
  FAKE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

// REQUIRED FOR DASHBOARD
enum CustomerState {
  NEW
  POST_CALL
  POST_CALL_REPLIED
  CUSTOMER_REPLIED
  QUALIFIED
  BOOKED
  CONVERTED
  LOST
}

// VAULT V1 Lead States
enum LeadState {
  NEW
  NEEDS_INFO
  QUALIFIED
  URGENT
  AWAITING_BOOKING
  CLOSED
}

// ONBOARDING State Machine
enum OnboardingStateEnum {
  S1_BUSINESS_TYPE_LOCATION
  S2_BUSINESS_NAME
  S3_OWNER_NAME
  S4_NOTIFICATION_PREF
  S5_CONFIRM_LIVE
  S6_PHONE_TYPE
  S7_FWD_SENT
  S8_FWD_CONFIRM
  S9_TEST_CALL
  COMPLETE
}

//
// ──────────────────────────────────────────────
// ALERT LOG (Ops Alerting)
// ──────────────────────────────────────────────
model AlertLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  alertType   String   @map("alert_type")
  alertKey    String   @map("alert_key")
  severity    String
  resourceId  String?  @map("resource_id")
  deliveredAt DateTime @map("delivered_at")
  channel     String
  metadata    Json?

  // Phase 5: Alert Acknowledgment (append-only, no unique constraint)
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by")
  resolution     String?

  @@index([alertType])
  @@index([alertKey])
  @@index([deliveredAt])
  @@index([acknowledgedAt])
  @@map("alert_logs")
}

//
// ──────────────────────────────────────────────
// TWILIO NUMBER POOL
// ──────────────────────────────────────────────
model TwilioNumberPool {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  phoneE164  String    @unique @map("phone_e164")
  status     String    @default("AVAILABLE")
  clientId   String?   @map("client_id")
  assignedAt DateTime? @map("assigned_at")

  @@index([status])
  @@index([clientId])
  @@map("twilio_number_pool")
}

//
// ──────────────────────────────────────────────
// CLIENT BILLING (TIER 2: COMMERCIAL TRUTH)
// ──────────────────────────────────────────────
model ClientBilling {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Foreign key (1:1 with Client)
  clientId  String   @unique @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // ⚠️ DO NOT UPDATE status DIRECTLY IN CODE
  // ⚠️ Use transitionBillingState() from billingTransitions.ts ONLY
  // SINGLE SOURCE OF TRUTH FOR BILLING STATE
  status           BillingStatus @default(TRIAL_PENDING) @map("status")
  paymentSource    PaymentSource @default(NONE) @map("payment_source")

  // Trial lifecycle (one-trial-per-phone enforcement)
  trialUsedAt      DateTime?     @map("trial_used_at")
  trialStartedAt   DateTime?     @map("trial_started_at")
  trialEndsAt      DateTime?     @map("trial_ends_at")

  // Subscription lifecycle
  subscriptionStartedAt DateTime?  @map("subscription_started_at")
  subscriptionEndsAt    DateTime?  @map("subscription_ends_at")

  // External payment provider (nullable - manual billing exists)
  stripeCustomerId      String?    @map("stripe_customer_id")
  stripeSubscriptionId  String?    @map("stripe_subscription_id")

  // Audit trail
  lastBillingEventAt    DateTime?  @map("last_billing_event_at")
  lastBillingEventType  String?    @map("last_billing_event_type")

  @@index([status])
  @@index([paymentSource])
  @@map("client_billing")
}

//
// ──────────────────────────────────────────────
// CLIENT CONTROLS (TIER 2: OPERATIONAL GATES)
// ──────────────────────────────────────────────
model ClientControls {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Foreign key (1:1 with Client)
  clientId  String   @unique @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Kill switch: Emergency SMS pause
  outboundPaused       Boolean   @default(false) @map("outbound_paused")
  outboundPausedAt     DateTime? @map("outbound_paused_at")
  outboundPausedReason String?   @map("outbound_paused_reason")

  // Kill switch: Force deterministic fallback
  aiDisabled           Boolean   @default(false) @map("ai_disabled")
  aiDisabledAt         DateTime? @map("ai_disabled_at")
  aiDisabledReason     String?   @map("ai_disabled_reason")

  // Ops Alerting Control (Phase 5: Moved from Client)
  opsAlertsMuted          Boolean   @default(false) @map("ops_alerts_muted")
  paymentGateAlertedAt    DateTime? @map("payment_gate_alerted_at")
  paymentGateAlertCount   Int       @default(0) @map("payment_gate_alert_count")

  @@map("client_controls")
}

//
// ──────────────────────────────────────────────
// BILLING EVENT LOG (TIER 2: STRIPE IDEMPOTENCY)
// ──────────────────────────────────────────────
model BillingEvent {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now()) @map("created_at")

  // Client reference (for querying history)
  clientId       String   @map("client_id")

  // Stripe event deduplication
  stripeEventId  String   @unique @map("stripe_event_id")
  eventType      String   @map("event_type")

  // Event payload (for debugging)
  eventData      Json?    @map("event_data")

  // Processing metadata
  processedAt    DateTime @map("processed_at")
  processingTimeMs Int?   @map("processing_time_ms")

  @@index([clientId])
  @@index([eventType])
  @@index([processedAt])
  @@map("billing_events")
}

//
// ──────────────────────────────────────────────
// BILLING ENUMS (TIER 2: EXPLICIT STATES)
// ──────────────────────────────────────────────

// Billing lifecycle state machine
enum BillingStatus {
  TRIAL_PENDING       // Onboarding incomplete
  TRIAL_ACTIVE        // 7-day trial running
  TRIAL_EXPIRED       // Trial ended, no payment
  ACTIVE              // Paying customer
  DELINQUENT          // Payment failed, grace period
  CANCELED            // Explicitly canceled
  SUSPENDED           // Admin/system suspended
}

// Payment method/source
enum PaymentSource {
  NONE                // No payment method attached
  STRIPE              // Stripe subscription
  MANUAL              // Manual invoicing (enterprise)
  WAIVED              // Free tier (partnerships)
}

//
// ──────────────────────────────────────────────
// ADMIN ACTION LOG (PHASE 5: AUDIT TRAIL)
// ──────────────────────────────────────────────
model AdminAction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Who performed the action
  adminId   String   @map("admin_id")

  // Which client was affected (null for global actions)
  clientId  String?  @map("client_id")

  // What action was performed
  action    String

  // Why (operator-provided justification)
  reason    String?

  // Additional context (e.g., alertId, previous state, etc.)
  metadata  Json?

  @@index([clientId])
  @@index([adminId])
  @@index([createdAt])
  @@index([action])
  @@map("admin_actions")
}
