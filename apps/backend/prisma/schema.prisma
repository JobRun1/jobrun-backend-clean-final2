generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ──────────────────────────────────────────────
// CLIENT
// ──────────────────────────────────────────────
model Client {
  id               String         @id @default(cuid())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  businessName     String
  region           String
  phoneNumber      String?
  twilioNumber     String?
  businessHours    Json?
  timezone         String         @default("America/New_York")
  demoToolsVisible Boolean        @default(true)
  demoClient       Boolean        @default(false)

  bookings         Booking[]
  conversations    Conversation[]
  customers        Customer[]
  messages         Message[]
  users            User[]
  leads            Lead[]

  @@map("clients")
}

//
// ──────────────────────────────────────────────
// USER
// ──────────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email     String   @unique
  password  String
  role      UserRole

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("users")
}

//
// ──────────────────────────────────────────────
// CUSTOMER
// ──────────────────────────────────────────────
// REQUIRED FOR ADMIN DASHBOARD
//
model Customer {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  clientId      String
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)

  phone         String
  name          String?
  email         String?

  // NEW FIELD REQUIRED BY DASHBOARD
  state         CustomerState  @default(NEW)

  bookings      Booking[]
  conversations Conversation[]
  messages      Message[]
  leads         Lead[]

  @@unique([clientId, phone], name: "clientId_phone")
  @@index([clientId])
  @@index([phone])
  @@index([state])
  @@map("customers")
}

//
// ──────────────────────────────────────────────
// CONVERSATION
// ──────────────────────────────────────────────
model Conversation {
  id         String    @id @default(cuid())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  clientId   String
  customerId String?

  client     Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  messages   Message[]

  @@index([clientId])
  @@index([customerId])
  @@map("conversations")
}

//
// ──────────────────────────────────────────────
// MESSAGE
// ──────────────────────────────────────────────
model Message {
  id             String           @id @default(cuid())
  createdAt      DateTime         @default(now())

  clientId       String
  customerId     String?
  conversationId String?
  leadId         String?

  direction      MessageDirection
  type           MessageType
  body           String

  twilioSid      String?          @unique
  metadata       Json?

  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer       Customer?        @relation(fields: [customerId], references: [id])
  conversation   Conversation?    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lead           Lead?            @relation(fields: [leadId], references: [id])

  @@index([clientId])
  @@index([customerId])
  @@index([conversationId])
  @@index([leadId])
  @@index([createdAt])
  @@map("messages")
}

//
// ──────────────────────────────────────────────
// BOOKING
// ──────────────────────────────────────────────
model Booking {
  id               String          @id @default(cuid())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  clientId         String
  customerId       String?

  start            DateTime
  end              DateTime
  status           BookingStatus   @default(NEW)

  customerName     String?
  customerPhone    String?
  customerEmail    String?
  notes            String?

  color            String?         @db.VarChar
  recurrenceRuleId String?         @db.VarChar
  isAllDay         Boolean         @default(false)
  externalSyncId   String?         @db.VarChar
  externalCalendar String?         @db.VarChar

  client           Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer         Customer?       @relation(fields: [customerId], references: [id])
  recurrenceRule   RecurrenceRule? @relation(fields: [recurrenceRuleId], references: [id])

  @@index([clientId, start])
  @@index([clientId, status])
  @@index([customerId])
  @@index([recurrenceRuleId])
  @@index([isAllDay])
  @@map("bookings")
}

//
// ──────────────────────────────────────────────
// RECURRENCE RULE
// ──────────────────────────────────────────────
model RecurrenceRule {
  id          String              @id @default(cuid())
  clientId    String

  frequency   RecurrenceFrequency
  interval    Int                 @default(1)

  byWeekday   String?
  byMonthday  String?
  endDate     DateTime?
  occurrences Int?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  bookings    Booking[]

  @@map("recurrence_rules")
}

//
// ──────────────────────────────────────────────
// WEEKLY AVAILABILITY
// ──────────────────────────────────────────────
model WeeklyAvailability {
  id        String @id @default(cuid())
  clientId  String
  weekday   Int
  startTime String
  endTime   String

  @@map("weekly_availability")
}

//
// ──────────────────────────────────────────────
// BLOCKED TIME
// ──────────────────────────────────────────────
model BlockedTime {
  id       String   @id @default(cuid())
  clientId String
  date     DateTime
  start    String?
  end      String?
  reason   String?

  @@map("blocked_times")
}

//
// ──────────────────────────────────────────────
// AGENT LOG
// ──────────────────────────────────────────────
model AgentLog {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())

  agentName       String
  clientId        String
  customerId      String?
  conversationId  String?

  trigger         String
  input           Json
  output          Json?
  error           String?
  executionTimeMs Int

  @@index([clientId])
  @@index([agentName])
  @@index([customerId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("agent_logs")
}

//
// ──────────────────────────────────────────────
// CLIENT SETTINGS
// ──────────────────────────────────────────────
model ClientSettings {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clientId      String   @unique

  businessName  String?
  services      String?
  availability  String?
  pricing       String?
  phoneNumber   String?
  email         String?
  website       String?
  serviceArea   String?
  theme         Json?
  agentSettings Json?
  metadata      Json?

  @@map("client_settings")
}

//
// ──────────────────────────────────────────────
// LEAD (VAULT V1)
// ──────────────────────────────────────────────
model Lead {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientId      String
  customerId    String

  state         LeadState @default(NEW)
  jobType       String    @default("")
  urgency       String    @default("")
  location      String    @default("")
  requestedTime String    @default("")
  notes         String    @default("")

  sentBooking   Boolean   @default(false)
  askedClarify  Boolean   @default(false)
  escalated     Boolean   @default(false)

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([clientId, customerId], name: "clientId_customerId")
  @@index([clientId])
  @@index([customerId])
  @@index([state])
  @@map("leads")
}

//
// ──────────────────────────────────────────────
// IMPERSONATION LOG
// ──────────────────────────────────────────────
model ImpersonationLog {
  id        String   @id @default(cuid())
  adminId   String
  clientId  String
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([adminId])
  @@index([clientId])
  @@index([createdAt])
  @@map("impersonation_logs")
}

//
// ──────────────────────────────────────────────
// HANDOVER STATE
// ──────────────────────────────────────────────
model HandoverState {
  id                 String    @id @default(cuid())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  conversationId     String    @unique
  clientId           String

  active             Boolean
  reason             String?
  urgencyScore       Int       @default(5)
  triggers           Json?
  lastNotificationAt DateTime?

  @@index([clientId])
  @@index([active])
  @@index([urgencyScore])
  @@map("handover_states")
}

//
// ──────────────────────────────────────────────
// ENUMS
// ──────────────────────────────────────────────
enum UserRole {
  ADMIN
  CLIENT
}

enum MessageDirection {
  INBOUND
  OUTBOUND
  SYSTEM
}

enum MessageType {
  SMS
  CALL
  NOTE
  EVENT
}

enum BookingStatus {
  NEW
  CONFIRMED
  CANCELLED
  MISSED
  RESCHEDULED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum LeadSource {
  INBOUND
  OUTBOUND
  REFERRAL
  WEBSITE
  OTHER
  FAKE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

// REQUIRED FOR DASHBOARD
enum CustomerState {
  NEW
  POST_CALL
  POST_CALL_REPLIED
  CUSTOMER_REPLIED
  QUALIFIED
  BOOKED
  CONVERTED
  LOST
}

// VAULT V1 Lead States
enum LeadState {
  NEW
  NEEDS_INFO
  QUALIFIED
  URGENT
  AWAITING_BOOKING
  CLOSED
}
